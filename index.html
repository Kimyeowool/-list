<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>오늘의 추천곡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* 기본 레이아웃 */
    body {
      margin: 0;
      padding: 0;
      background: black;
      color: white;
      font-family: sans-serif;
      overflow: hidden;
      text-align: center;
    }

    /* 배경 플레이어 컨테이너 */
    #background-player {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: -1;
      pointer-events: none;
    }

    /* 미니 플레이어 (우측 하단) */
    .mini-player {
      position: fixed;
      bottom: 20px; right: 20px;
      width: 300px; height: 170px;
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    /* API가 삽입하는 iframe에 100% 크기 적용 */
    .mini-player iframe {
      width: 100%; height: 100%;
    }

    /* 본문 콘텐츠 */
    .content {
      position: relative;
      z-index: 1;
      padding-top: 15vh;
    }
    h1 { font-size: 2.4rem; margin-bottom: 0.5rem; }
    #song-title { margin-bottom: 1.5rem; }

    button {
      margin: 5px;
      padding: 10px 16px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: white;
      color: black;
    }
    button.liked {
      background: #ffcccc !important;
    }
  </style>
</head>
<body>

  <!-- ① 배경 플레이어를 삽입할 빈 div -->
  <div id="background-player"></div>

  <!-- ② 우측 하단 미니 플레이어 -->
  <div class="mini-player">
    <div id="mini-player"></div>
  </div>

  <!-- ③ 버튼 & 텍스트 -->
  <div class="content">
    <h1>오늘의 추천곡</h1>
    <div id="song-title">장르를 선택해 주세요</div>

    <!-- 장르 버튼 -->
    <div>
      <button onclick="fetchRandomSong('indie')">🎧 인디</button>
      <button onclick="fetchRandomSong('pop')">🎤 팝송</button>
      <button onclick="fetchRandomSong('jpop')">🎌 일본</button>
    </div>

    <!-- 좋아요/목록/공유 -->
    <div style="margin-top:1.5rem;">
      <button id="like-btn">❤️ 좋아요</button>
      <button id="show-likes-btn">🧡 좋아요 목록</button>
      <button id="share-btn">🔗 공유하기</button>
    </div>
  </div>

  <!-- YouTube IFrame API 로드 (이 순서 중요) -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    // 🎧 재생목록 ID 모음
    const playlists = {
      indie: 'PLu4x1UBAg4x-3KehjcCtooRennNoUW66q',
      pop:   'PLu4x1UBAg4x_iktia7qLOURp1fOsSOz7d',
      jpop:  'PLu4x1UBAg4x8lyQztvvlOEBFAxC_F3TBU'
    };

    let backgroundPlayer, miniPlayer;
    let currentSong = {};

    // API 준비되면 호출
    function onYouTubeIframeAPIReady() {
      // 미니 플레이어
      miniPlayer = new YT.Player('mini-player', {
        height: '170',
        width: '300',
        videoId: '',  // 나중에 채워짐
        playerVars: {
          autoplay: 1,
          controls: 1,
          modestbranding: 1,
          rel: 0,
          playsinline: 1
        }
      });

      // 배경 플레이어
      backgroundPlayer = new YT.Player('background-player', {
        height: '100%',
        width: '100%',
        videoId: '',  // 나중에 채워짐
        playerVars: {
          autoplay: 1,
          mute: 1,
          controls: 0,
          loop: 1,
          playlist: '',
          modestbranding: 1,
          rel: 0,
          playsinline: 1
        },
        events: {
          onReady: e => {
            e.target.mute();
          }
        }
      });

      // 시각 차이를 매초 맞춰줌
      setInterval(syncPlayers, 1000);
    }

    // 플레이어 동기화 (광고 있고 없고 시간 차이 클 때 보정)
    function syncPlayers() {
      if (!miniPlayer || !backgroundPlayer) return;
      const t1 = miniPlayer.getCurrentTime?.() || 0;
      const t2 = backgroundPlayer.getCurrentTime?.() || 0;
      if (Math.abs(t1 - t2) > 1.0) {
        backgroundPlayer.seekTo(t1, true);
      }
    }

    // 랜덤 곡 가져와서 재생
    async function fetchRandomSong(genre) {
      const listId = playlists[genre];
      const url = `https://www.googleapis.com/youtube/v3/playlistItems?` +
                  `part=snippet&playlistId=${listId}&maxResults=50&key=AIzaSyC3dFjg5VnEvtcnUH-dh_nGFRb9ztDxEeE`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        const items = data.items || [];
        if (!items.length) {
          alert('곡이 없습니다.');
          return;
        }
        const idx = Math.floor(Math.random() * items.length);
        const vid = items[idx].snippet.resourceId.videoId;
        const title = items[idx].snippet.title;

        currentSong = { videoId: vid, title };

        // 제목 업데이트
        document.getElementById('song-title').textContent =
          `오늘의 추천곡: ${title}`;

        // 두 플레이어에 로드
        miniPlayer.loadVideoById(vid);
        backgroundPlayer.loadVideoById({ videoId: vid });

        updateLikeBtn();
      } catch (err) {
        console.error(err);
        alert('추천곡 불러오는 중 오류');
      }
    }

    // 좋아요 버튼 토글
    function updateLikeBtn() {
      const likes = JSON.parse(localStorage.getItem('likedSongs')||'[]');
      const exists = likes.some(s=>s.videoId===currentSong.videoId);
      document.getElementById('like-btn')
        .classList.toggle('liked', exists);
    }

    // 클릭 이벤트 바인딩
    document.getElementById('like-btn')
      .addEventListener('click', ()=>{
        if (!currentSong.videoId) return;
        let likes = JSON.parse(localStorage.getItem('likedSongs')||'[]');
        const idx = likes.findIndex(s=>s.videoId===currentSong.videoId);
        if (idx>=0) {
          likes.splice(idx,1);
          alert('좋아요 취소');
        } else {
          likes.push(currentSong);
          alert('좋아요 추가');
        }
        localStorage.setItem('likedSongs', JSON.stringify(likes));
        updateLikeBtn();
      });

    document.getElementById('show-likes-btn')
      .addEventListener('click', ()=>{
        const likes = JSON.parse(localStorage.getItem('likedSongs')||'[]');
        if (!likes.length) return alert('좋아요한 곡이 없습니다.');
        alert('❤️ 좋아요 목록:\n\n' + likes.map(s=>s.title).join('\n'));
      });

    document.getElementById('share-btn')
      .addEventListener('click', ()=>{
        if (!currentSong.videoId) return alert('먼저 곡 선택');
        const link = `https://youtu.be/${currentSong.videoId}`;
        navigator.clipboard.writeText(link)
          .then(()=>alert('링크 복사됨:\n'+link))
          .catch(()=>alert('복사 실패'));
      });
  </script>
</body>
</html>
