<body>
  <!-- ... 생략: mini-player, background-player, 버튼 등 ... -->

  <!-- 유튜브 API 먼저 로딩 -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <!-- 우리 스크립트는 맨 마지막에 -->
  <script>
    let miniPlayer, backgroundPlayer;

    const playlists = {
      indie: ['dQw4w9WgXcQ', 'kXYiU_JCYtU'],
      pop: ['3JZ4pnNtyxQ', 'RgKAFK5djSk'],
      japanese: ['Zi_XLOBDo_Y', 'x8VYWazR5mE']
    };

    function fetchRandomSong(genre) {
      const list = playlists[genre];
      const randomId = list[Math.floor(Math.random() * list.length)];
      playVideo(randomId);
    }

    function playVideo(videoId) {
      if (miniPlayer && backgroundPlayer) {
        miniPlayer.loadVideoById(videoId);
        backgroundPlayer.loadVideoById(videoId);
      }
    }

    function onYouTubeIframeAPIReady() {
      const defaultId = 'dQw4w9WgXcQ';

      miniPlayer = new YT.Player('mini-player', {
        videoId: defaultId,
        playerVars: { autoplay: 1, controls: 1 }
      });

      backgroundPlayer = new YT.Player('background-player', {
        videoId: defaultId,
        playerVars: { autoplay: 1, controls: 0, mute: 1, loop: 1, playlist: defaultId },
        events: {
          onReady: e => e.target.mute()
        }
      });

      setInterval(() => {
        if (miniPlayer && backgroundPlayer &&
            typeof miniPlayer.getCurrentTime === 'function' &&
            typeof backgroundPlayer.getCurrentTime === 'function') {
          const t1 = miniPlayer.getCurrentTime();
          const t2 = backgroundPlayer.getCurrentTime();
          if (Math.abs(t1 - t2) > 1) {
            backgroundPlayer.seekTo(t1, true);
          }
        }
      }, 1000);
    }
  </script>
</body>
