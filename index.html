<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì˜¤ëŠ˜ì˜ ì¶”ì²œê³¡</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
    body {
      margin: 0;
      padding: 0;
      background: black;
      color: white;
      font-family: sans-serif;
      overflow: hidden;
      text-align: center;
    }

    /* ë°°ê²½ í”Œë ˆì´ì–´ ì»¨í…Œì´ë„ˆ */
    #background-player {
      position: fixed;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      z-index: -1;
      pointer-events: none;
    }

    /* ë¯¸ë‹ˆ í”Œë ˆì´ì–´ (ìš°ì¸¡ í•˜ë‹¨) */
    .mini-player {
      position: fixed;
      bottom: 20px; right: 20px;
      width: 300px; height: 170px;
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
    }
    /* APIê°€ ì‚½ì…í•˜ëŠ” iframeì— 100% í¬ê¸° ì ìš© */
    .mini-player iframe {
      width: 100%; height: 100%;
    }

    /* ë³¸ë¬¸ ì½˜í…ì¸  */
    .content {
      position: relative;
      z-index: 1;
      padding-top: 15vh;
    }
    h1 { font-size: 2.4rem; margin-bottom: 0.5rem; }
    #song-title { margin-bottom: 1.5rem; }

    button {
      margin: 5px;
      padding: 10px 16px;
      font-size: 1rem;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      background: white;
      color: black;
    }
    button.liked {
      background: #ffcccc !important;
    }
  </style>
</head>
<body>

  <!-- â‘  ë°°ê²½ í”Œë ˆì´ì–´ë¥¼ ì‚½ì…í•  ë¹ˆ div -->
  <div id="background-player"></div>

  <!-- â‘¡ ìš°ì¸¡ í•˜ë‹¨ ë¯¸ë‹ˆ í”Œë ˆì´ì–´ -->
  <div class="mini-player">
    <div id="mini-player"></div>
  </div>

  <!-- â‘¢ ë²„íŠ¼ & í…ìŠ¤íŠ¸ -->
  <div class="content">
    <h1>ì˜¤ëŠ˜ì˜ ì¶”ì²œê³¡</h1>
    <div id="song-title">ì¥ë¥´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”</div>

    <!-- ì¥ë¥´ ë²„íŠ¼ -->
    <div>
      <button onclick="fetchRandomSong('indie')">ğŸ§ ì¸ë””</button>
      <button onclick="fetchRandomSong('pop')">ğŸ¤ íŒì†¡</button>
      <button onclick="fetchRandomSong('jpop')">ğŸŒ ì¼ë³¸</button>
    </div>

    <!-- ì¢‹ì•„ìš”/ëª©ë¡/ê³µìœ  -->
    <div style="margin-top:1.5rem;">
      <button id="like-btn">â¤ï¸ ì¢‹ì•„ìš”</button>
      <button id="show-likes-btn">ğŸ§¡ ì¢‹ì•„ìš” ëª©ë¡</button>
      <button id="share-btn">ğŸ”— ê³µìœ í•˜ê¸°</button>
    </div>
  </div>

  <!-- YouTube IFrame API ë¡œë“œ (ì´ ìˆœì„œ ì¤‘ìš”) -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    // ğŸ§ ì¬ìƒëª©ë¡ ID ëª¨ìŒ
    const playlists = {
      indie: 'PLu4x1UBAg4x-3KehjcCtooRennNoUW66q',
      pop:   'PLu4x1UBAg4x_iktia7qLOURp1fOsSOz7d',
      jpop:  'PLu4x1UBAg4x8lyQztvvlOEBFAxC_F3TBU'
    };

    let backgroundPlayer, miniPlayer;
    let currentSong = {};

    // API ì¤€ë¹„ë˜ë©´ í˜¸ì¶œ
    function onYouTubeIframeAPIReady() {
      // ë¯¸ë‹ˆ í”Œë ˆì´ì–´
      miniPlayer = new YT.Player('mini-player', {
        height: '170',
        width: '300',
        videoId: '',  // ë‚˜ì¤‘ì— ì±„ì›Œì§
        playerVars: {
          autoplay: 1,
          controls: 1,
          modestbranding: 1,
          rel: 0,
          playsinline: 1
        }
      });

      // ë°°ê²½ í”Œë ˆì´ì–´
      backgroundPlayer = new YT.Player('background-player', {
        height: '100%',
        width: '100%',
        videoId: '',  // ë‚˜ì¤‘ì— ì±„ì›Œì§
        playerVars: {
          autoplay: 1,
          mute: 1,
          controls: 0,
          loop: 1,
          playlist: '',
          modestbranding: 1,
          rel: 0,
          playsinline: 1
        },
        events: {
          onReady: e => {
            e.target.mute();
          }
        }
      });

      // ì‹œê° ì°¨ì´ë¥¼ ë§¤ì´ˆ ë§ì¶°ì¤Œ
      setInterval(syncPlayers, 1000);
    }

    // í”Œë ˆì´ì–´ ë™ê¸°í™” (ê´‘ê³  ìˆê³  ì—†ê³  ì‹œê°„ ì°¨ì´ í´ ë•Œ ë³´ì •)
    function syncPlayers() {
      if (!miniPlayer || !backgroundPlayer) return;
      const t1 = miniPlayer.getCurrentTime?.() || 0;
      const t2 = backgroundPlayer.getCurrentTime?.() || 0;
      if (Math.abs(t1 - t2) > 1.0) {
        backgroundPlayer.seekTo(t1, true);
      }
    }

    // ëœë¤ ê³¡ ê°€ì ¸ì™€ì„œ ì¬ìƒ
    async function fetchRandomSong(genre) {
      const listId = playlists[genre];
      const url = `https://www.googleapis.com/youtube/v3/playlistItems?` +
                  `part=snippet&playlistId=${listId}&maxResults=50&key=AIzaSyC3dFjg5VnEvtcnUH-dh_nGFRb9ztDxEeE`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        const items = data.items || [];
        if (!items.length) {
          alert('ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.');
          return;
        }
        const idx = Math.floor(Math.random() * items.length);
        const vid = items[idx].snippet.resourceId.videoId;
        const title = items[idx].snippet.title;

        currentSong = { videoId: vid, title };

        // ì œëª© ì—…ë°ì´íŠ¸
        document.getElementById('song-title').textContent =
          `ì˜¤ëŠ˜ì˜ ì¶”ì²œê³¡: ${title}`;

        // ë‘ í”Œë ˆì´ì–´ì— ë¡œë“œ
        miniPlayer.loadVideoById(vid);
        backgroundPlayer.loadVideoById({ videoId: vid });

        updateLikeBtn();
      } catch (err) {
        console.error(err);
        alert('ì¶”ì²œê³¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜');
      }
    }

    // ì¢‹ì•„ìš” ë²„íŠ¼ í† ê¸€
    function updateLikeBtn() {
      const likes = JSON.parse(localStorage.getItem('likedSongs')||'[]');
      const exists = likes.some(s=>s.videoId===currentSong.videoId);
      document.getElementById('like-btn')
        .classList.toggle('liked', exists);
    }

    // í´ë¦­ ì´ë²¤íŠ¸ ë°”ì¸ë”©
    document.getElementById('like-btn')
      .addEventListener('click', ()=>{
        if (!currentSong.videoId) return;
        let likes = JSON.parse(localStorage.getItem('likedSongs')||'[]');
        const idx = likes.findIndex(s=>s.videoId===currentSong.videoId);
        if (idx>=0) {
          likes.splice(idx,1);
          alert('ì¢‹ì•„ìš” ì·¨ì†Œ');
        } else {
          likes.push(currentSong);
          alert('ì¢‹ì•„ìš” ì¶”ê°€');
        }
        localStorage.setItem('likedSongs', JSON.stringify(likes));
        updateLikeBtn();
      });

    document.getElementById('show-likes-btn')
      .addEventListener('click', ()=>{
        const likes = JSON.parse(localStorage.getItem('likedSongs')||'[]');
        if (!likes.length) return alert('ì¢‹ì•„ìš”í•œ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.');
        alert('â¤ï¸ ì¢‹ì•„ìš” ëª©ë¡:\n\n' + likes.map(s=>s.title).join('\n'));
      });

    document.getElementById('share-btn')
      .addEventListener('click', ()=>{
        if (!currentSong.videoId) return alert('ë¨¼ì € ê³¡ ì„ íƒ');
        const link = `https://youtu.be/${currentSong.videoId}`;
        navigator.clipboard.writeText(link)
          .then(()=>alert('ë§í¬ ë³µì‚¬ë¨:\n'+link))
          .catch(()=>alert('ë³µì‚¬ ì‹¤íŒ¨'));
      });
  </script>
</body>
</html>
